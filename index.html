<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Choose your plan</title>
  <link rel="preload" href="https://cdn.shopify.com/s/files/1/2320/2099/files/Cambon-Regular_2.woff2?v=1756082377" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="https://cdn.shopify.com/s/files/1/2320/2099/files/GeneralSans-Medium_1.woff2?v=1756082377" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face {
      font-family: 'Cambon';
      src: url('https://cdn.shopify.com/s/files/1/2320/2099/files/Cambon-Regular_2.woff2?v=1756082377') format('woff2');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'General Sans';
      src: url('https://cdn.shopify.com/s/files/1/2320/2099/files/GeneralSans-Medium_1.woff2?v=1756082377') format('woff2');
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'General Sans Medium';
      src: url('https://cdn.shopify.com/s/files/1/2320/2099/files/GeneralSans-Medium_1.woff2?v=1756082377') format('woff2');
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { overflow-x: hidden; overflow-y: auto; min-height: 100vh; font-family: 'General Sans', sans-serif; color: #817364; }
    .pricing-section { display: flex; justify-content: center; min-height: 100vh; font-family: 'General Sans', sans-serif; }
    .pricing-section h2 { font-family: 'Cambon', serif; font-size: 1.4rem; margin-bottom: 8px; font-weight: 600; color: #422112; }
    .pricing-container { display: flex; flex-wrap: wrap; width: 100%; min-height: 100vh; }
    .plan-box { flex: 1 1 40%; min-width: 400px; padding: 20px 40px 40px; display: flex; flex-direction: column; justify-content: flex-start; font-family: 'General Sans', sans-serif; }
    .divider { width: 100px; height: 3px; background: #FF9DDD; margin-bottom: 20px; }
    .pricing-section h3 { font-family: 'General Sans', sans-serif; font-size: 1.25rem; font-weight: 700; margin-bottom: 10px; color: #422112; text-align: center; }
    .subtext { font-family: 'General Sans', sans-serif; font-weight: 400; color: #817364; font-size: 0.95rem; margin-bottom: 30px; text-align: center; }
    .pricing-options { display: flex; flex-direction: column; gap: 15px; }
    .pricing-card { background: transparent; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s ease; position: relative; }
    .pricing-card:hover { border-color: #FF9DDD; transform: translateY(-2px); }
    .pricing-card.active { border-color: #8B4513; border-width: 3px; color: #422112; }
    .pricing-card[data-plan="yearly"]:not(.active) .card-header, .pricing-card[data-plan="yearly"]:not(.active) .save, .pricing-card[data-plan="yearly"]:not(.active) .price-row { display: none; }
    .pricing-card[data-plan="yearly"]:not(.active) .unselected-content { display: flex; justify-content: space-between; align-items: center; }
    .pricing-card[data-plan="yearly"].active .unselected-content { display: none; }
    .pricing-card[data-plan="monthly"]:not(.active) .card-header, .pricing-card[data-plan="monthly"]:not(.active) .price-row { display: none; }
    .pricing-card[data-plan="monthly"]:not(.active) .unselected-content { display: flex; justify-content: space-between; align-items: center; }
    .pricing-card[data-plan="monthly"].active .unselected-content { display: none; }
    .unselected-content .price-amount { font-size: 1.5rem; font-weight: 700; color: #422112; }
    .unselected-content .plan-name { font-size: 1.2rem; font-weight: 600; color: #422112; }
    .best-value { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #FF9DDD; color: white; font-weight: 700; font-size: 0.9rem; padding: 6px 16px; border-radius: 20px; white-space: nowrap; }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .card-header h4 { font-family: 'General Sans Medium', sans-serif; font-size: 1.2rem; margin: 0; }
    .save { font-family: 'General Sans', sans-serif; color: #FF9DDD; font-weight: 700; }
    .price-details { margin-top: 20px; }
    .price-row { display: flex; justify-content: space-between; align-items: flex-end; }
    .price-info { display: flex; flex-direction: column; }
    .price-label { font-family: 'General Sans', sans-serif; font-size: 0.9rem; color: #817364; text-transform: uppercase; margin-bottom: 5px; }
    .price-amount { font-family: 'General Sans', sans-serif; font-size: 1.5rem; font-weight: 700; color: #422112; }
    .pricing-card.active .price-amount { font-size: 1.75rem; font-weight: 800; }
    .unselected-content .plan-name { font-family: 'General Sans', sans-serif; }
    .cta-button { font-family: 'General Sans', sans-serif; width: 100%; padding: 12px 20px; background: #ed4580; color: white; border: none; border-radius: 360px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 24px; height: 48px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; }
    .cta-button:hover { transform: translateY(-1px); }
    .cta-button:disabled { opacity: 0.7; cursor: not-allowed; }
    .image-box { flex: 1 1 60%; min-width: 500px; background: #e0f4ff; display: flex; align-items: center; justify-content: center; }
    .image-box img { width: 100%; height: 100%; object-fit: cover; }
    .step-header { margin-bottom: 20px; }
    .back-btn-wrap { display: none; margin-bottom: 16px; }
    .step-payment .plan-box .back-btn-wrap { display: flex !important; align-items: center; }
    .back-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid #e2e8f0; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; transition: border-color 0.2s, background 0.2s; color: #422112; }
    .back-btn:hover { border-color: #ed4580; background: rgba(237, 69, 128, 0.06); }
    .back-btn svg { width: 18px; height: 18px; }
    .stripe-loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; color: #817364; font-size: 0.9rem; }
    .stripe-loading-spinner .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: #ed4580; border-radius: 50%; animation: stripe-spin 0.8s linear infinite; margin-bottom: 12px; }
    @keyframes stripe-spin { to { transform: rotate(360deg); } }
    .heading-step { font-family: 'Cambon', serif; font-size: 1.4rem; font-weight: 600; color: #422112; margin-bottom: 8px; }
    .heading-step.heading-payment { display: none; }
    .step-payment .plan-box .heading-step.heading-plan { display: none !important; }
    .step-payment .plan-box .heading-step.heading-payment { display: block !important; }
    .progress-bar { display: flex; gap: 4px; width: 100%; margin-top: 12px; margin-bottom: 4px; }
    .progress-segment { flex: 1; height: 6px; border-radius: 3px; background: #e2e8f0; transition: background 0.3s ease; }
    .progress-segment.step-1 { background: #ed4580; }
    .progress-segment.step-2.filled { background: #ed4580; }
    .step-payment .plan-box .progress-segment.step-2 { background: #ed4580; }
    .progress-labels { display: flex; justify-content: space-between; font-family: 'General Sans', sans-serif; font-size: 0.75rem; color: #817364; margin-top: 4px; }
    .selection-summary { display: none; background: #fff; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; font-family: 'General Sans', sans-serif; box-shadow: 0 1px 3px rgba(0,0,0,0.08); flex-direction: row; align-items: center; justify-content: space-between; gap: 12px; }
    .step-payment .plan-box .selection-summary { display: flex !important; }
    .selection-summary .summary-plan { font-size: 18px; font-weight: 600; color: #422112; margin: 0; }
    .selection-summary .summary-today { font-size: 18px; color: #422112; margin: 0; }
    #stripe-embed-container { width: 100%; min-height: 280px; display: none; }
    .step-payment .plan-box .plan-choice-block { display: none !important; }
    .step-payment .plan-box #stripe-embed-container { display: block !important; }
    .checkout-email-wrap { display: none; margin-bottom: 20px; }
    .step-payment .plan-box .checkout-email-wrap { display: block !important; }
    .checkout-email-wrap label { display: block; font-family: 'General Sans', sans-serif; font-size: 0.9rem; font-weight: 600; color: #422112; margin-bottom: 6px; }
    .checkout-email-wrap input { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-family: inherit; }
    .checkout-email-wrap input:focus { outline: none; border-color: #ed4580; }
    #pay-button-container { display: none; margin-top: 20px; }
    .step-payment .plan-box #pay-button-container { display: block !important; }
    #payment-step-error { color: #c00; margin-top: 12px; font-size: 0.9rem; display: none; }
    .error-msg { color: #c00; margin-top: 12px; font-size: 0.9rem; }
    .success-section { display: none; min-height: 100vh; padding: 40px 20px; font-family: 'General Sans', sans-serif; }
    body.show-success .success-section { display: flex; align-items: center; justify-content: center; }
    body.show-success .pricing-section { display: none !important; }
    .success-section .success-box { text-align: center; max-width: 420px; }
    .success-section .success-box h1 { font-family: 'Cambon', serif; font-size: 1.75rem; color: #422112; margin-bottom: 12px; }
    .success-section .success-box p { color: #817364; font-size: 1rem; line-height: 1.5; margin-bottom: 12px; }
    .success-email-note { font-size: 0.9rem; color: #422112; margin: 20px 0 16px; padding: 12px; background: rgba(237, 69, 128, 0.08); border-radius: 8px; }
    .success-app-links { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 24px 0 20px; }
    .success-app-link { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: #422112; color: #fff; border-radius: 8px; text-decoration: none; font-size: 0.95rem; font-weight: 600; transition: background 0.2s; }
    .success-app-link:hover { background: #5a2d1a; color: #fff; }
    .success-app-link svg { width: 22px; height: 22px; flex-shrink: 0; }
    .success-support { margin-top: 20px; font-size: 0.9rem; }
    .success-support a { color: #ed4580; font-weight: 600; text-decoration: none; }
    .success-support a:hover { text-decoration: underline; }
    @media (max-width: 767px) {
      .pricing-container { flex-direction: column; }
      .plan-box { min-width: auto; order: 2; padding: 20px; }
      .image-box { display: none !important; }
    }
    @media (max-width: 480px) {
      .plan-box { padding: 30px 20px; }
    }
  </style>
</head>
<body>
  <section class="pricing-section" id="pricing-section">
    <div class="pricing-container">
      <div class="plan-box">
        <div class="step-header">
          <div class="back-btn-wrap">
            <button type="button" class="back-btn" id="back-link" aria-label="Back to plan selection">
              <svg viewBox="0 0 48 48" fill="currentColor" aria-hidden="true"><path d="M.894 5.21A3.052 3.052 0 0 1 5.21.894L16 11.684 26.79.894A3.052 3.052 0 0 1 31.106 5.21L18.158 18.158a3.052 3.052 0 0 1-4.1.2l-.218-.2Z" transform="translate(33.526 7.526) rotate(90)"/></svg>
            </button>
          </div>
          <h2 class="heading-step heading-plan" id="heading-plan">Choose your plan</h2>
          <h2 class="heading-step heading-payment" id="heading-payment">Payment</h2>
          <div class="progress-bar">
            <div class="progress-segment step-1" aria-label="Plan selection"></div>
            <div class="progress-segment step-2" id="progress-step-2" aria-label="Payment"></div>
          </div>
          <div class="progress-labels">
            <span>Plan selection</span>
            <span>Payment</span>
          </div>
        </div>
        <div class="plan-choice-block">
          <h3>7 Day Free Trial</h3>
          <p class="subtext">You won't be charged until your trial ends. Cancel anytime.</p>
          <div class="pricing-options">
            <div class="pricing-card active" data-plan="yearly" onclick="selectPlan('yearly')">
              <div class="best-value">BEST VALUE</div>
              <div class="card-header">
                <h4>Yearly</h4>
                <span class="save">SAVE 30%</span>
              </div>
              <div class="price-details">
                <div class="price-row">
                  <div class="price-info">
                    <div class="price-label" style="text-decoration: line-through; opacity: 0.6;">A$199 BILLED</div>
                    <div class="price-label" style="color: #FF9DDD; font-weight: 700;">A$139.30 BILLED</div>
                    <div class="price-label">YEARLY AFTER TRIAL</div>
                  </div>
                  <div class="price-info">
                    <div class="price-amount">A$11.6</div>
                    <div class="price-label">PER MONTH</div>
                  </div>
                </div>
                <div class="unselected-content">
                  <div class="plan-name">Yearly</div>
                  <div class="price-amount">A$11.6/month</div>
                </div>
              </div>
            </div>
            <div class="pricing-card" data-plan="monthly" onclick="selectPlan('monthly')">
              <div class="card-header"><h4>Monthly</h4></div>
              <div class="price-details">
                <div class="price-row">
                  <div class="price-info">
                    <div class="price-label">A$39 BILLED</div>
                    <div class="price-label">MONTHLY</div>
                  </div>
                  <div class="price-info">
                    <div class="price-amount">A$39</div>
                    <div class="price-label">PER MONTH</div>
                  </div>
                </div>
                <div class="unselected-content">
                  <div class="plan-name">Monthly</div>
                  <div class="price-amount">A$39/month</div>
                </div>
              </div>
            </div>
          </div>
          <button type="button" class="cta-button" id="continue-btn">Continue</button>
          <div id="step1-error" class="error-msg" style="display: none;"></div>
        </div>
        <div class="selection-summary" id="selection-summary" aria-hidden="true">
          <p class="summary-plan" id="summary-plan">Yearly</p>
          <p class="summary-today" id="summary-today">A$0.00 Today</p>
        </div>
        <div class="checkout-email-wrap" id="checkout-email-wrap">
          <label for="checkout-email">Email address</label>
          <input type="email" id="checkout-email" name="email" placeholder="you@example.com" required autocomplete="email">
        </div>
        <div id="stripe-embed-container"></div>
        <div id="pay-button-container">
          <button type="button" class="cta-button" id="pay-btn">Confirm Purchase</button>
          <div id="payment-step-error" class="error-msg"></div>
        </div>
      </div>
      <div class="image-box">
        <img src="https://cdn.shopify.com/s/files/1/2320/2099/files/231208_TRANSFORM22441_4.jpg?v=1769565606" alt="FitAz Transform">
      </div>
    </div>
  </section>

  <section class="success-section" id="success-section" aria-hidden="true">
    <div class="success-box">
      <h1>Thank you</h1>
      <p>Your subscription is confirmed. Check your email for details.</p>
      <p class="success-email-note">Use the <strong>same email</strong> you used to purchase when signing in to the app.</p>
      <p style="margin-bottom: 8px; font-weight: 600; color: #422112;">Download the app</p>
      <div class="success-app-links">
        <a class="success-app-link" href="https://apps.apple.com/au/app/transform-by-fitaz/id1438373600" target="_blank" rel="noopener noreferrer" aria-label="Download on the App Store">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
          App Store
        </a>
        <a class="success-app-link" href="https://play.google.com/store/apps/details?id=com.fitazfk.transform&hl=en_AU" target="_blank" rel="noopener noreferrer" aria-label="Get it on Google Play">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3.609 1.814L13.792 12 3.61 22.186a.996.996 0 0 1-.61-.92V2.734a1 1 0 0 1 .609-.92zm10.89 10.893l2.302 2.302-10.937 6.333 8.635-8.635zm3.199-3.198l2.807 1.626a1 1 0 0 1 0 1.73l-2.808 1.626L15.206 12l2.492-2.491zM5.864 2.658L16.802 8.99l-2.302 2.302-8.636-8.634z"/></svg>
          Google Play
        </a>
      </div>
      <p class="success-support">Portal link (use anytime): <a href="https://billing.stripe.com/p/login/dRm5kw5JHdUSfh01xqeME00" target="_blank" rel="noopener noreferrer">Manage your billing</a>. Share this link or send it to customers to manage their subscription.</p>
      <p class="success-support">Need help? <a href="https://transformbyfitaz.gorgias.help/en-US" target="_blank" rel="noopener noreferrer">Contact support</a></p>
    </div>
  </section>

  <script src="https://js.stripe.com/clover/stripe.js"></script>
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      if (params.get('success') === '1' && params.get('session_id')) {
        document.body.classList.add('show-success');
        var successEl = document.getElementById('success-section');
        if (successEl) successEl.setAttribute('aria-hidden', 'false');
        return;
      }

      var selectedPlan = 'yearly';
      var cachedPublishableKey = null;

      function loadGA4(measurementId) {
        if (!measurementId || window.gtag) return;
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        window.gtag = gtag;
        gtag('js', new Date());
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=' + measurementId;
        document.head.appendChild(s);
        s.onload = function() { gtag('config', measurementId); };
      }
      function gtagEvent(name, params) {
        if (window.gtag) window.gtag('event', name, params || {});
      }

      fetch('/api/config').then(function(r) { return r.json(); }).then(function(data) {
        cachedPublishableKey = data.publishableKey || '';
        if (data.gaMeasurementId) loadGA4(data.gaMeasurementId);
      }).catch(function() {});

      function getPublishableKey() {
        if (cachedPublishableKey) return Promise.resolve(cachedPublishableKey);
        return fetch('/api/config').then(function(r) {
          if (!r.ok) return Promise.reject(new Error('Config returned ' + r.status));
          return r.json();
        }).then(function(data) {
          cachedPublishableKey = data.publishableKey || '';
          return cachedPublishableKey;
        });
      }

      function selectPlan(plan) {
        selectedPlan = plan;
        gtagEvent('select_plan', { plan: plan });
        document.querySelectorAll('.pricing-card').forEach(function(card) {
          card.classList.remove('active');
        });
        document.querySelector('[data-plan="' + plan + '"]').classList.add('active');
      }

      function showPaymentStep(show) {
        var section = document.getElementById('pricing-section');
        var seg2 = document.getElementById('progress-step-2');
        section.classList.toggle('step-payment', show);
        if (seg2) seg2.classList.toggle('filled', show);
        if (show) {
          var planLabel = selectedPlan === 'yearly' ? 'Yearly' : 'Monthly';
          var planEl = document.getElementById('summary-plan');
          var todayEl = document.getElementById('summary-today');
          if (planEl) planEl.textContent = planLabel;
          if (todayEl) todayEl.textContent = 'A$0.00 Today';
        }
      }

      function showError(msg) {
        var el = document.getElementById('step1-error');
        el.textContent = msg || '';
        el.style.display = msg ? 'block' : 'none';
      }

      function getUtmParams() {
        var params = new URLSearchParams(window.location.search);
        var utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id'];
        var out = {};
        utmKeys.forEach(function(key) {
          var val = params.get(key);
          if (val && val.trim()) out[key] = val.trim();
        });
        return out;
      }

      document.getElementById('continue-btn').addEventListener('click', function(ev) {
        ev.preventDefault();
        ev.stopPropagation();
        var btn = this;
        btn.disabled = true;
        showError('');
        var payload = Object.assign({ plan: selectedPlan }, getUtmParams());
        fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
          .then(function(result) {
            if (!result.ok) {
              showError(result.data.error || 'Something went wrong.');
              btn.disabled = false;
              return;
            }
            var clientSecret = result.data.client_secret;
            var returnUrl = result.data.return_url || (window.location.origin + window.location.pathname.replace(/\/$/, '') + '/?session_id={CHECKOUT_SESSION_ID}&success=1');
            if (!clientSecret) {
              showError('No checkout session received.');
              btn.disabled = false;
              return;
            }
            showPaymentStep(true);
            btn.disabled = false;
            gtagEvent('begin_checkout', { plan: selectedPlan, currency: 'AUD' });
            var container = document.getElementById('stripe-embed-container');
            container.innerHTML = '<div class="stripe-loading-spinner"><div class="spinner"></div><span>Loading payment formâ€¦</span></div>';
            getPublishableKey().then(function(key) {
              if (!key) {
                container.innerHTML = '<p style="color:#c00;">Set STRIPE_PUBLISHABLE_KEY in Vercel env (see README).</p>';
                return;
              }
              try {
                var stripeInstance = Stripe(key);
                var checkout = stripeInstance.initCheckout({ clientSecret: Promise.resolve(clientSecret) });
                window._currentCheckout = checkout;
                window._currentClientSecret = clientSecret;
                window._currentReturnUrl = returnUrl;
                var paymentElement = checkout.createPaymentElement();
                container.innerHTML = '';
                paymentElement.mount('#stripe-embed-container');
                gtagEvent('add_payment_info', { plan: selectedPlan, currency: 'AUD' });
                document.getElementById('payment-step-error').style.display = 'none';
                document.getElementById('payment-step-error').textContent = '';
              } catch (err) {
                container.innerHTML = '<p class="error-msg">Could not load payment form: ' + (err.message || err) + '</p>';
              }
            }).catch(function(err) {
              var msg = 'Could not load Stripe config. ';
              if (err && err.message) msg += err.message + '. ';
              msg += 'Set STRIPE_PUBLISHABLE_KEY or REACT_APP_STRIPE_PUBLISHABLE_KEY in Vercel and ensure /api/config is reachable.';
              container.innerHTML = '<p style="color:#c00;">' + msg + '</p>';
            });
          })
          .catch(function(err) {
            showError('Network error. Please try again.');
            btn.disabled = false;
          });
      });

      document.getElementById('pay-btn').addEventListener('click', function(ev) {
        ev.preventDefault();
        var checkout = window._currentCheckout;
        var clientSecret = window._currentClientSecret;
        var returnUrl = window._currentReturnUrl;
        if (!checkout || !clientSecret) return;
        var emailInput = document.getElementById('checkout-email');
        var email = emailInput ? emailInput.value.trim() : '';
        if (!email) {
          document.getElementById('payment-step-error').textContent = 'Please enter your email address.';
          document.getElementById('payment-step-error').style.display = 'block';
          return;
        }
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          document.getElementById('payment-step-error').textContent = 'Please enter a valid email address.';
          document.getElementById('payment-step-error').style.display = 'block';
          return;
        }
        var payBtn = this;
        payBtn.disabled = true;
        document.getElementById('payment-step-error').style.display = 'none';
        document.getElementById('payment-step-error').textContent = '';
        checkout.loadActions()
          .then(function(loadResult) { return loadResult.actions.confirm({ email: email }); })
          .then(function(result) {
            if (result && result.error) {
              document.getElementById('payment-step-error').textContent = result.error.message || 'Payment failed.';
              document.getElementById('payment-step-error').style.display = 'block';
              payBtn.disabled = false;
              return;
            }
            var sessionId = clientSecret.split('_secret_')[0];
            gtagEvent('purchase', { transaction_id: sessionId, plan: selectedPlan, currency: 'AUD', value: 0 });
            if (returnUrl && sessionId) {
              window.location = returnUrl.replace('{CHECKOUT_SESSION_ID}', sessionId);
            }
          })
          .catch(function(err) {
            document.getElementById('payment-step-error').textContent = err.message || 'Something went wrong.';
            document.getElementById('payment-step-error').style.display = 'block';
            payBtn.disabled = false;
          });
      });

      document.getElementById('back-link').addEventListener('click', function(ev) {
        ev.preventDefault();
        gtagEvent('back_to_plan', { from: 'payment' });
        showPaymentStep(false);
        document.getElementById('stripe-embed-container').innerHTML = '';
        var emailEl = document.getElementById('checkout-email');
        if (emailEl) emailEl.value = '';
        window._currentCheckout = null;
        window._currentClientSecret = null;
        window._currentReturnUrl = null;
      });
      document.getElementById('back-link').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); }
      });

      window.selectPlan = selectPlan;
    })();
  </script>
</body>
</html>
