<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Choose your plan</title>
  <link rel="preload" href="https://cdn.shopify.com/s/files/1/2320/2099/files/Cambon-Regular_2.woff2?v=1756082377" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="https://cdn.shopify.com/s/files/1/2320/2099/files/GeneralSans-Medium_1.woff2?v=1756082377" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face {
      font-family: 'Cambon';
      src: url('https://cdn.shopify.com/s/files/1/2320/2099/files/Cambon-Regular_2.woff2?v=1756082377') format('woff2');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'General Sans';
      src: url('https://cdn.shopify.com/s/files/1/2320/2099/files/GeneralSans-Medium_1.woff2?v=1756082377') format('woff2');
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'General Sans Medium';
      src: url('https://cdn.shopify.com/s/files/1/2320/2099/files/GeneralSans-Medium_1.woff2?v=1756082377') format('woff2');
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { overflow-x: hidden; overflow-y: auto; min-height: 100vh; font-family: 'General Sans', sans-serif; color: #817364; }
    .pricing-section { display: flex; justify-content: center; min-height: 100vh; font-family: 'General Sans', sans-serif; }
    .pricing-section h2 { font-family: 'Cambon', serif; font-size: 1.4rem; margin-bottom: 8px; font-weight: 600; color: #422112; }
    .pricing-container { display: flex; flex-wrap: wrap; width: 100%; min-height: 100vh; }
    .plan-box { flex: 1 1 40%; min-width: 400px; padding: 20px 40px 40px; display: flex; flex-direction: column; justify-content: flex-start; font-family: 'General Sans', sans-serif; }
    .divider { width: 100px; height: 3px; background: #FF9DDD; margin-bottom: 20px; }
    .pricing-section h3 { font-family: 'General Sans', sans-serif; font-size: 1.25rem; font-weight: 700; margin-bottom: 10px; color: #422112; text-align: center; }
    .subtext { font-family: 'General Sans', sans-serif; font-weight: 400; color: #817364; font-size: 0.95rem; margin-bottom: 30px; text-align: center; }
    .pricing-options { display: flex; flex-direction: column; gap: 15px; }
    .pricing-card { background: transparent; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s ease; position: relative; }
    .pricing-card:hover { border-color: #FF9DDD; transform: translateY(-2px); }
    .pricing-card.active { border-color: #8B4513; border-width: 3px; color: #422112; }
    .pricing-card[data-plan="yearly"]:not(.active) .card-header, .pricing-card[data-plan="yearly"]:not(.active) .save, .pricing-card[data-plan="yearly"]:not(.active) .price-row { display: none; }
    .pricing-card[data-plan="yearly"]:not(.active) .unselected-content { display: flex; justify-content: space-between; align-items: center; }
    .pricing-card[data-plan="yearly"].active .unselected-content { display: none; }
    .pricing-card[data-plan="monthly"]:not(.active) .card-header, .pricing-card[data-plan="monthly"]:not(.active) .price-row { display: none; }
    .pricing-card[data-plan="monthly"]:not(.active) .unselected-content { display: flex; justify-content: space-between; align-items: center; }
    .pricing-card[data-plan="monthly"].active .unselected-content { display: none; }
    .unselected-content .price-amount { font-size: 1.5rem; font-weight: 700; color: #422112; }
    .unselected-content .plan-name { font-size: 1.2rem; font-weight: 600; color: #422112; }
    .best-value { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #FF9DDD; color: white; font-weight: 700; font-size: 0.9rem; padding: 6px 16px; border-radius: 20px; white-space: nowrap; }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .card-header h4 { font-family: 'General Sans Medium', sans-serif; font-size: 1.2rem; margin: 0; }
    .save { font-family: 'General Sans', sans-serif; color: #FF9DDD; font-weight: 700; }
    .price-details { margin-top: 20px; }
    .price-row { display: flex; justify-content: space-between; align-items: flex-end; }
    .price-info { display: flex; flex-direction: column; }
    .price-label { font-family: 'General Sans', sans-serif; font-size: 0.9rem; color: #817364; text-transform: uppercase; margin-bottom: 5px; }
    .price-amount { font-family: 'General Sans', sans-serif; font-size: 1.5rem; font-weight: 700; color: #422112; }
    .pricing-card.active .price-amount { font-size: 1.75rem; font-weight: 800; }
    .unselected-content .plan-name { font-family: 'General Sans', sans-serif; }
    .cta-button { font-family: 'General Sans', sans-serif; width: 100%; padding: 12px 20px; background: #ed4580; color: white; border: none; border-radius: 360px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 24px; height: 48px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; }
    .cta-button:hover { transform: translateY(-1px); }
    .cta-button:disabled { opacity: 0.7; cursor: not-allowed; }
    .image-box { flex: 1 1 60%; min-width: 500px; background: #e0f4ff; display: flex; align-items: center; justify-content: center; }
    .image-box img { width: 100%; height: 100%; object-fit: cover; }
    .step-header { margin-bottom: 20px; }
    .back-link { font-family: 'General Sans', sans-serif; display: none; margin-bottom: 12px; color: #ed4580; cursor: pointer; text-decoration: underline; font-size: 0.95rem; }
    .back-link:hover { color: #422112; }
    .step-payment .plan-box .back-link { display: inline-block !important; }
    .heading-step { font-family: 'Cambon', serif; font-size: 1.4rem; font-weight: 600; color: #422112; margin-bottom: 8px; }
    .heading-step.heading-payment { display: none; }
    .step-payment .plan-box .heading-step.heading-plan { display: none !important; }
    .step-payment .plan-box .heading-step.heading-payment { display: block !important; }
    .progress-bar { display: flex; gap: 4px; width: 100%; margin-top: 12px; margin-bottom: 4px; }
    .progress-segment { flex: 1; height: 6px; border-radius: 3px; background: #e2e8f0; transition: background 0.3s ease; }
    .progress-segment.step-1 { background: #ed4580; }
    .progress-segment.step-2.filled { background: #ed4580; }
    .step-payment .plan-box .progress-segment.step-2 { background: #ed4580; }
    .progress-labels { display: flex; justify-content: space-between; font-family: 'General Sans', sans-serif; font-size: 0.75rem; color: #817364; margin-top: 4px; }
    .selection-summary { display: none; background: #fff; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; font-family: 'General Sans', sans-serif; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .step-payment .plan-box .selection-summary { display: block !important; }
    .selection-summary .summary-plan { font-size: 18px; font-weight: 600; color: #422112; margin: 0 0 4px 0; }
    .selection-summary .summary-today { font-size: 18px; color: #422112; margin: 0; }
    #stripe-embed-container { width: 100%; min-height: 280px; display: none; }
    .step-payment .plan-box .plan-choice-block { display: none !important; }
    .step-payment .plan-box #stripe-embed-container { display: block !important; }
    #pay-button-container { display: none; margin-top: 20px; }
    .step-payment .plan-box #pay-button-container { display: block !important; }
    #payment-step-error { color: #c00; margin-top: 12px; font-size: 0.9rem; display: none; }
    .error-msg { color: #c00; margin-top: 12px; font-size: 0.9rem; }
    @media (max-width: 767px) {
      .pricing-container { flex-direction: column; }
      .plan-box { min-width: auto; order: 2; padding: 20px; }
      .image-box { order: 1; height: 50vh; min-width: auto; flex: none; }
    }
    @media (max-width: 480px) {
      .plan-box { padding: 30px 20px; }
      .image-box { height: 40vh; }
    }
  </style>
</head>
<body>
  <section class="pricing-section" id="pricing-section">
    <div class="pricing-container">
      <div class="plan-box">
        <div class="step-header">
          <a role="button" class="back-link" id="back-link" tabindex="0">‚Üê Back</a>
          <h2 class="heading-step heading-plan" id="heading-plan">Choose your plan</h2>
          <h2 class="heading-step heading-payment" id="heading-payment">Payment</h2>
          <div class="progress-bar">
            <div class="progress-segment step-1" aria-label="Plan selection"></div>
            <div class="progress-segment step-2" id="progress-step-2" aria-label="Payment"></div>
          </div>
          <div class="progress-labels">
            <span>Plan selection</span>
            <span>Payment</span>
          </div>
        </div>
        <div class="plan-choice-block">
          <h3>7 Day Free Trial</h3>
          <p class="subtext">You won't be charged until your trial ends. Cancel anytime.</p>
          <div class="pricing-options">
            <div class="pricing-card active" data-plan="yearly" onclick="selectPlan('yearly')">
              <div class="best-value">BEST VALUE</div>
              <div class="card-header">
                <h4>Yearly</h4>
                <span class="save">SAVE 30%</span>
              </div>
              <div class="price-details">
                <div class="price-row">
                  <div class="price-info">
                    <div class="price-label" style="text-decoration: line-through; opacity: 0.6;">A$199 BILLED</div>
                    <div class="price-label" style="color: #FF9DDD; font-weight: 700;">A$139.30 BILLED</div>
                    <div class="price-label">YEARLY AFTER TRIAL</div>
                  </div>
                  <div class="price-info">
                    <div class="price-amount">A$11.6</div>
                    <div class="price-label">PER MONTH</div>
                  </div>
                </div>
                <div class="unselected-content">
                  <div class="plan-name">Yearly</div>
                  <div class="price-amount">A$11.6/month</div>
                </div>
              </div>
            </div>
            <div class="pricing-card" data-plan="monthly" onclick="selectPlan('monthly')">
              <div class="card-header"><h4>Monthly</h4></div>
              <div class="price-details">
                <div class="price-row">
                  <div class="price-info">
                    <div class="price-label">A$39 BILLED</div>
                    <div class="price-label">MONTHLY</div>
                  </div>
                  <div class="price-info">
                    <div class="price-amount">A$39</div>
                    <div class="price-label">PER MONTH</div>
                  </div>
                </div>
                <div class="unselected-content">
                  <div class="plan-name">Monthly</div>
                  <div class="price-amount">A$39/month</div>
                </div>
              </div>
            </div>
          </div>
          <button type="button" class="cta-button" id="continue-btn">Continue</button>
          <div id="step1-error" class="error-msg" style="display: none;"></div>
        </div>
        <div class="selection-summary" id="selection-summary" aria-hidden="true">
          <p class="summary-plan" id="summary-plan">Yearly</p>
          <div><p class="summary-today" id="summary-today">A$0.00 Today</p></div>
        </div>
        <div id="stripe-embed-container"></div>
        <div id="pay-button-container">
          <button type="button" class="cta-button" id="pay-btn">Subscribe</button>
          <div id="payment-step-error" class="error-msg"></div>
        </div>
      </div>
      <div class="image-box">
        <img src="https://cdn.shopify.com/s/files/1/2320/2099/files/231208_TRANSFORM22441_4.jpg?v=1769565606" alt="FitAz Transform">
      </div>
    </div>
  </section>

  <script src="https://js.stripe.com/clover/stripe.js"></script>
  <script>
    (function() {
      var selectedPlan = 'yearly';
      var cachedPublishableKey = null;
      function getPublishableKey() {
        if (cachedPublishableKey) return Promise.resolve(cachedPublishableKey);
        return fetch('/api/config').then(function(r) {
          if (!r.ok) return Promise.reject(new Error('Config returned ' + r.status));
          return r.json();
        }).then(function(data) {
          cachedPublishableKey = data.publishableKey || '';
          return cachedPublishableKey;
        });
      }

      function selectPlan(plan) {
        selectedPlan = plan;
        document.querySelectorAll('.pricing-card').forEach(function(card) {
          card.classList.remove('active');
        });
        document.querySelector('[data-plan="' + plan + '"]').classList.add('active');
      }

      function showPaymentStep(show) {
        var section = document.getElementById('pricing-section');
        var seg2 = document.getElementById('progress-step-2');
        section.classList.toggle('step-payment', show);
        if (seg2) seg2.classList.toggle('filled', show);
        if (show) {
          var planLabel = selectedPlan === 'yearly' ? 'Yearly' : 'Monthly';
          var planEl = document.getElementById('summary-plan');
          var todayEl = document.getElementById('summary-today');
          if (planEl) planEl.textContent = planLabel;
          if (todayEl) todayEl.textContent = 'A$0.00 Today';
        }
      }

      function showError(msg) {
        var el = document.getElementById('step1-error');
        el.textContent = msg || '';
        el.style.display = msg ? 'block' : 'none';
      }

      document.getElementById('continue-btn').addEventListener('click', function(ev) {
        ev.preventDefault();
        ev.stopPropagation();
        var btn = this;
        btn.disabled = true;
        showError('');
        fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan: selectedPlan })
        })
          .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
          .then(function(result) {
            if (!result.ok) {
              showError(result.data.error || 'Something went wrong.');
              btn.disabled = false;
              return;
            }
            var clientSecret = result.data.client_secret;
            var returnUrl = result.data.return_url || (window.location.origin + window.location.pathname.replace(/\/$/, '') + '/?session_id={CHECKOUT_SESSION_ID}&success=1');
            if (!clientSecret) {
              showError('No checkout session received.');
              btn.disabled = false;
              return;
            }
            showPaymentStep(true);
            btn.disabled = false;
            getPublishableKey().then(function(key) {
              if (!key) {
                document.getElementById('stripe-embed-container').innerHTML = '<p style="color:#c00;">Set STRIPE_PUBLISHABLE_KEY in Vercel env (see README).</p>';
                return;
              }
              try {
                var stripeInstance = Stripe(key);
                var checkout = stripeInstance.initCheckout({ clientSecret: Promise.resolve(clientSecret) });
                window._currentCheckout = checkout;
                window._currentClientSecret = clientSecret;
                window._currentReturnUrl = returnUrl;
                var paymentElement = checkout.createPaymentElement();
                paymentElement.mount('#stripe-embed-container');
                document.getElementById('payment-step-error').style.display = 'none';
                document.getElementById('payment-step-error').textContent = '';
              } catch (err) {
                document.getElementById('stripe-embed-container').innerHTML = '<p class="error-msg">Could not load payment form: ' + (err.message || err) + '</p>';
              }
            }).catch(function(err) {
              var msg = 'Could not load Stripe config. ';
              if (err && err.message) msg += err.message + '. ';
              msg += 'Set STRIPE_PUBLISHABLE_KEY or REACT_APP_STRIPE_PUBLISHABLE_KEY in Vercel and ensure /api/config is reachable.';
              document.getElementById('stripe-embed-container').innerHTML = '<p style="color:#c00;">' + msg + '</p>';
            });
          })
          .catch(function(err) {
            showError('Network error. Please try again.');
            btn.disabled = false;
          });
      });

      document.getElementById('pay-btn').addEventListener('click', function(ev) {
        ev.preventDefault();
        var checkout = window._currentCheckout;
        var clientSecret = window._currentClientSecret;
        var returnUrl = window._currentReturnUrl;
        if (!checkout || !clientSecret) return;
        var payBtn = this;
        payBtn.disabled = true;
        document.getElementById('payment-step-error').style.display = 'none';
        document.getElementById('payment-step-error').textContent = '';
        checkout.loadActions()
          .then(function(loadResult) { return loadResult.actions.confirm(); })
          .then(function(result) {
            if (result && result.error) {
              document.getElementById('payment-step-error').textContent = result.error.message || 'Payment failed.';
              document.getElementById('payment-step-error').style.display = 'block';
              payBtn.disabled = false;
              return;
            }
            var sessionId = clientSecret.split('_secret_')[0];
            if (returnUrl && sessionId) {
              window.location = returnUrl.replace('{CHECKOUT_SESSION_ID}', sessionId);
            }
          })
          .catch(function(err) {
            document.getElementById('payment-step-error').textContent = err.message || 'Something went wrong.';
            document.getElementById('payment-step-error').style.display = 'block';
            payBtn.disabled = false;
          });
      });

      document.getElementById('back-link').addEventListener('click', function(ev) {
        ev.preventDefault();
        showPaymentStep(false);
        document.getElementById('stripe-embed-container').innerHTML = '';
        window._currentCheckout = null;
        window._currentClientSecret = null;
        window._currentReturnUrl = null;
      });
      document.getElementById('back-link').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); }
      });

      window.selectPlan = selectPlan;
    })();
  </script>
</body>
</html>
